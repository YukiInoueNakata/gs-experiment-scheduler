<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title><?= title ?></title>
    <style>
      body{font-family:system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; padding:16px; max-width:900px; margin:auto;}
      .card{border:1px solid #ddd; border-radius:12px; padding:16px; margin:12px 0;}
      .btn{padding:10px 16px; border-radius:8px; border:none; background:#111; color:#fff; cursor:pointer;}
      .btn[disabled]{opacity:.5; cursor:not-allowed;}
      .muted{color:#666;}
      .grid{display:grid; gap:12px;}
      .grid-2{grid-template-columns:1fr 1fr;}
      .slot{display:flex; align-items:center; gap:8px; padding:8px 0; border-bottom:1px dashed #eee;}
      .hidden{display:none;}
    </style>
  </head>
  <body>
    <h1><?= title ?></h1>

    <!-- Step 1: 同意＋個人情報 -->
    <div id="step1" class="card">
      <div><?!= consentHtml ?></div> <!-- ← 非エスケープで挿入 -->
      <label><input type="checkbox" id="agree"> 内容に同意します</label>
      <div class="grid grid-2" style="margin-top:12px;">
        <div>
          <label>お名前<br><input id="name" style="width:100%; padding:8px;"></label>
        </div>
        <div>
          <label>メールアドレス<br><input id="email" style="width:100%; padding:8px;"></label>
        </div>
        <div>
          <label>メールアドレス（確認）<br><input id="email2" style="width:100%; padding:8px;"></label>
          <small class="muted">※ 上と同じメールをもう一度</small>
        </div>
      </div>
      <div style="margin-top:12px;">
        <button id="toStep2" class="btn" disabled>次へ（日時選択）</button>
      </div>
    </div>

    <!-- Step 2: 日時選択 -->
    <div id="step2" class="card hidden">
      <h2>希望日時の選択</h2>
      <div id="slots" class="grid"></div>
      <div style="margin-top:12px;">
        <button id="submit" class="btn">申し込む</button>
      </div>
      <div id="msg" class="muted" style="margin-top:8px;"></div>
    </div>

    <script>
      const agree = document.getElementById('agree');
      const nameEl = document.getElementById('name');
      const emailEl = document.getElementById('email');
      const email2El = document.getElementById('email2');
      const toStep2 = document.getElementById('toStep2');
      const step1 = document.getElementById('step1');
      const step2 = document.getElementById('step2');
      const slotsWrap = document.getElementById('slots');
      const btnSubmit = document.getElementById('submit');
      const msg = document.getElementById('msg');

      function checkNext(){
        const ok = agree.checked &&
                   nameEl.value.trim().length>0 &&
                   emailEl.value.trim().length>0 &&
                   emailEl.value.trim()===email2El.value.trim();
        toStep2.disabled = !ok;
      }
      [agree, nameEl, emailEl, email2El].forEach(el => el.addEventListener('input', checkNext));
      checkNext();

      toStep2.addEventListener('click', () => {
        step1.classList.add('hidden');
        step2.classList.remove('hidden');
        msg.textContent = '読み込み中…';
        google.script.run
          .withSuccessHandler(renderSlots)
          .withFailureHandler(e => { msg.textContent = 'スロット取得エラー: ' + e.message; })
          .getSlots();
      });

      function renderSlots(res){
        msg.textContent = '';
        slotsWrap.innerHTML = '';
        const byDate = {};
        res.slots.forEach(s => {
          if (s.remaining<=0) return; // 満席非表示
          (byDate[s.dateLabel]||(byDate[s.dateLabel]=[])).push(s);
        });
        Object.keys(byDate).sort().forEach(dateLabel=>{
          const col = document.createElement('div');
          col.className = 'card';
          const h = document.createElement('h3');
          h.textContent = dateLabel;
          col.appendChild(h);
          byDate[dateLabel].forEach(s=>{
            const div = document.createElement('div'); div.className='slot';
            const cb = document.createElement('input'); cb.type='checkbox'; cb.value = s.slotId;
            const span = document.createElement('span'); span.textContent = s.start + ' - ' + s.end;
            div.appendChild(cb); div.appendChild(span);
            col.appendChild(div);
          });
          slotsWrap.appendChild(col);
        });
        if (!slotsWrap.innerHTML) {
          slotsWrap.innerHTML = '<p class="muted">表示できる日時がありません。</p>';
        }
      }

      btnSubmit.addEventListener('click', ()=>{
        const name = nameEl.value.trim();
        const email = emailEl.value.trim();
        const slotIds = Array.from(slotsWrap.querySelectorAll('input[type=checkbox]:checked')).map(i=>i.value);
        if (!slotIds.length){ msg.textContent='希望日時を選んでください。'; return; }
        msg.textContent='送信中…';
        google.script.run
          .withSuccessHandler(res => { msg.textContent = res.message || '送信しました。'; btnSubmit.disabled = true; })
          .withFailureHandler(e => { msg.textContent = 'エラー: ' + e.message; })
          .register(name, email, slotIds);
      });
    </script>
  </body>
</html>